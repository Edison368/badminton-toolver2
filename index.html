<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>バドミントンチーム分けツール</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f4f4f9;
      color: #333;
    }

    header {
      text-align: center;
      padding: 20px;
      background-color: #4CAF50;
      color: white;
    }

    header img {
      width: 50px;
    }

    .inputs {
      margin-top: 20px;
      text-align: center;
    }

    .inputs textarea,
    .inputs input,
    .inputs button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }

    .inputs button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }

    .inputs button:hover {
      background-color: #45a049;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    h3 {
      color: #4CAF50;
    }

    .bold-text {
      font-weight: bold;
    }

    .share-container {
      text-align: center;
      margin-top: 20px;
    }

    .share-container input {
      width: 70%;
      padding: 10px;
      margin-top: 10px;
    }

    .share-container button {
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }

    .player-list {
      text-align: center;
      margin-top: 20px;
    }

    .player-list ul {
      list-style-type: none;
      padding-left: 0;
    }

    .player-list li {
      font-size: 18px;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTaFxuFtnA0V3zsmO_XSDUVFhbErsh_851E8w&s" alt="Logo">
    <h2>🏸 バドミントンチーム分けツール</h2>
  </header>

  <div class="inputs">
    <div>
      <label for="playerNames">プレイヤー名 (改行で区切る):</label><br>
      <textarea id="playerNames" rows="4" cols="50"></textarea>
    </div>
    <div>
      <label for="courtCount">コート数:</label>
      <input type="number" id="courtCount" value="1" min="1" />
    </div>
    <div>
      <label for="totalRounds">ラウンド数:</label>
      <input type="number" id="totalRounds" value="1" min="1" />
    </div>
    <div>
      <label for="additionalPlayers">途中参加プレイヤー (改行で区切る):</label><br>
      <textarea id="additionalPlayers" rows="4" cols="50"></textarea>
    </div>
    <div>
      <label for="additionalCourt">途中参加ラウンド:</label>
      <input type="number" id="additionalCourt" value="1" min="1" />
    </div>
    <button onclick="generateRounds()">🎯 対戦を生成</button>
    <button onclick="generateShareLink()">🔗 シェアリンクを生成</button>
    <button onclick="copyShareLink()">📋 リンクをコピー</button>
  </div>

  <div class="result" id="output"></div>

  <div class="player-list">
    <h3>📋 登録済みプレイヤー</h3>
    <ul id="playerList"></ul>
  </div>

  <div class="share-container">
    <input type="text" id="shareLink" readonly />
  </div>

  <script>
    let playCountMap = {};
    let pairHistory = {};
    let allPairs = [];

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function generateRounds() {
      const names = document.getElementById("playerNames").value.trim().split("\n").filter(n => n.trim());
      shuffle(names); // 順番固定回避のためシャッフル
      const courtCount = parseInt(document.getElementById("courtCount").value);
      const totalRounds = parseInt(document.getElementById("totalRounds").value);
      const additionalPlayers = document.getElementById("additionalPlayers").value.trim().split("\n").filter(n => n.trim());
      const additionalCourt = parseInt(document.getElementById("additionalCourt").value) || 1;
      const output = document.getElementById("output");
      output.innerHTML = "";

      const originalPlayers = names.map(name => name.trim());
      const lateJoiners = additionalPlayers.map(name => ({ name: name.trim(), startRound: additionalCourt }));

      playCountMap = {};
      pairHistory = {};
      allPairs = [];
      [...originalPlayers, ...lateJoiners.map(p => p.name)].forEach(p => playCountMap[p] = 0);

      let fullHtml = "";

      for (let roundNumber = 1; roundNumber <= totalRounds; roundNumber++) {
        let availablePlayers = [...originalPlayers];
        lateJoiners.forEach(p => {
          if (roundNumber >= p.startRound) availablePlayers.push(p.name);
        });

        availablePlayers.sort((a, b) => playCountMap[a] - playCountMap[b]);
        const selectedPlayers = availablePlayers.slice(0, courtCount * 4);
        shuffle(selectedPlayers); // 偏り回避

        let html = `<h3>第 ${roundNumber} ラウンド</h3>`;
        html += "<table><tr><th>コート</th><th>チーム A</th><th>チーム B</th></tr>";

        const used = new Set();

        function findTeamPair(players, used, avoidPairs = []) {
          const possiblePairs = [];

          for (let i = 0; i < players.length; i++) {
            if (used.has(players[i])) continue;
            for (let j = i + 1; j < players.length; j++) {
              if (used.has(players[j])) continue;
              const pairKey = [players[i], players[j]].sort().join(",");
              if (!pairHistory[pairKey] && !avoidPairs.includes(pairKey)) {
                possiblePairs.push([players[i], players[j]]);
              }
            }
          }

          if (possiblePairs.length === 0) {
            for (let i = 0; i < players.length; i++) {
              if (used.has(players[i])) continue;
              for (let j = i + 1; j < players.length; j++) {
                if (used.has(players[j])) continue;
                return [players[i], players[j]];
              }
            }
          }

          possiblePairs.sort((a, b) => {
            const aKey = [a[0], a[1]].sort().join(",");
            const bKey = [b[0], b[1]].sort().join(",");
            return (pairHistory[aKey] || 0) - (pairHistory[bKey] || 0);
          });

          return possiblePairs[0];
        }

        if (Object.keys(pairHistory).length === selectedPlayers.length * (selectedPlayers.length - 1) / 2) {
          pairHistory = {};
          allPairs = [];
        }

        for (let i = 0; i < courtCount; i++) {
          if (selectedPlayers.length - used.size < 4) {
            html += `<tr><td>コート ${i + 1}</td><td colspan="2">自由練習</td></tr>`;
            continue;
          }

          const teamA = findTeamPair(selectedPlayers, used, allPairs);
          if (!teamA) break;
          used.add(teamA[0]); used.add(teamA[1]);

          const teamB = findTeamPair(selectedPlayers, used, allPairs);
          if (!teamB) break;
          used.add(teamB[0]); used.add(teamB[1]);

          const aKey = [teamA[0], teamA[1]].sort().join(",");
          const bKey = [teamB[0], teamB[1]].sort().join(",");
          pairHistory[aKey] = (pairHistory[aKey] || 0) + 1;
          pairHistory[bKey] = (pairHistory[bKey] || 0) + 1;
          allPairs.push(aKey, bKey);

          teamA.forEach(p => playCountMap[p]++);
          teamB.forEach(p => playCountMap[p]++);

          html += `<tr><td>コート ${i + 1}</td><td class="bold-text">${teamA.join(" & ")}</td><td class="bold-text">${teamB.join(" & ")}</td></tr>`;
        }

        html += "</table>";
        fullHtml += html;
      }

      fullHtml += "<h3>🏅 総出場統計</h3><table><tr><th>プレイヤー</th><th>出場回数</th></tr>";
      for (const [name, count] of Object.entries(playCountMap)) {
        fullHtml += `<tr><td>${name}</td><td>${count}</td></tr>`;
      }
      fullHtml += "</table>";

      output.innerHTML = fullHtml;
    }

    function generateShareLink() {
      const court = document.getElementById("courtCount").value;
      const rounds = document.getElementById("totalRounds").value;
      const names = encodeURIComponent(document.getElementById("playerNames").value.trim());
      const addNames = encodeURIComponent(document.getElementById("additionalPlayers").value.trim());
      const addStart = document.getElementById("additionalCourt").value;

      const params = new URLSearchParams({
        court, rounds, names, addNames, addStart
      });

      const shareURL = `${window.location.origin}${window.location.pathname}?${params.toString()}`;
      document.getElementById("shareLink").value = shareURL;
    }

    function copyShareLink() {
      const linkInput = document.getElementById("shareLink");
      linkInput.select();
      document.execCommand("copy");
      alert("リンクをコピーしました！");
    }

    window.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);

      const names = params.get("names");
      if (names) document.getElementById("playerNames").value = decodeURIComponent(names);

      const addNames = params.get("addNames");
      if (addNames) document.getElementById("additionalPlayers").value = decodeURIComponent(addNames);

      const court = params.get("court");
      if (court) document.getElementById("courtCount").value = court;

      const rounds = params.get("rounds");
      if (rounds) document.getElementById("totalRounds").value = rounds;

      const addStart = params.get("addStart");
      if (addStart) document.getElementById("additionalCourt").value = addStart;

      if (names) generateRounds(); // 自動生成

      // Display players from URL
      const playerNames = decodeURIComponent(params.get("names") || '').split("\n").filter(n => n.trim());
      const playerListElement = document.getElementById("playerList");
      
      if (playerNames.length > 0) {
        playerNames.forEach(name => {
          const li = document.createElement("li");
          li.textContent = name;
          playerListElement.appendChild(li);
        });
      } else {
        const li = document.createElement("li");
        li.textContent = "まだ誰も参加していません";
        playerListElement.appendChild(li);
      }
    });
  </script>
</body>
</html>
